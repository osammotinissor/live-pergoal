<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>live dal pronosticone</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;600&display=swap" rel="stylesheet">

  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/4.3.0/css/fixedColumns.dataTables.min.css">

  <style>
    body {
      font-family: "Montserrat", sans-serif;
      margin: 12px;
      background-color: #f5f5dc !important;
    }

    /* sfondo uniforme tabella + header */
    table.dataTable,
    table.dataTable tbody td,
    table.dataTable thead th {
      background-color: #f5f5dc !important;
    }

    /* sfondo anche alle colonne fissate */
    .dtfc-fixed-left,
    .dtfc-fixed-left tbody tr td,
    .dtfc-fixed-left thead tr th {
      background-color: #f5f5dc !important;
    }

    /* header fisso */
    table.dataTable thead th {
      position: sticky;
      top: 0;
      z-index: 2;
    }
    
    /* righe compatte */
    table.dataTable tbody td {
      padding: 2px 6px !important;
    }
    table.dataTable thead th {
      padding: 4px 6px !important;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* evidenziazione TOT / CHI massimi */
    .max-value {
      font-weight: 700;
      color: #0066ff;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>live pronosticone</h2>
    <p id="status">Caricamento dati…</p>
    <table id="sheetTable" class="display stripe" style="width:100%">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- jQuery + DataTables + FixedColumns -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedcolumns/4.3.0/js/dataTables.fixedColumns.min.js"></script>

  <script>
  (function(){

    var API_URL = "https://script.google.com/macros/s/AKfycbzsOt3qpVNsmrgulWRMRa3eNjjVyTQ9rtJqKHcLok7DaqkqVb5zYHZqRpZ6Rdtd8TTB/exec";

    function setStatus(msg) {
      document.getElementById("status").innerText = msg;
    }

    $.ajax({
      url: API_URL + "?callback=?",
      dataType: "jsonp",
      timeout: 20000,
      success: function(data) {
        if (!data || !data.length) {
          setStatus("Nessun dato disponibile.");
          return;
        }

        setStatus("Dati caricati.");

        // ricava tutte le chiavi
        var keys = [];
        data.forEach(row => {
          Object.keys(row).forEach(k => {
            if (!keys.includes(k)) keys.push(k);
          });
        });

        // filtra righe: esclude solo tot === "---"
        data = data.filter(row => row["tot"] !== "---");

        if (data.length === 0) {
          setStatus("Nessuna riga valida da visualizzare.");
          return;
        }

        // crea header
        var thead = "<tr>" + keys.map(k => "<th>" + k + "</th>").join("") + "</tr>";
        $("#sheetTable thead").html(thead);

        // trova valore massimo TOT
        let maxTot = Math.max(...data.map(r => Number(r["tot"]) || 0));

        // DataTable
        $("#sheetTable").DataTable({
          data: data,
          columns: keys.map(k => ({
            data: function(row) {
              return row[k] !== undefined && row[k] !== "" ? row[k] : "---";
            },
            title: k
          })),

          pageLength: 25,
          lengthMenu: [10, 25, 50, 100],
          scrollX: true,
          scrollY: "70vh",
          scrollCollapse: true,
          deferRender: true,
          order: [],
          fixedColumns: { leftColumns: 2 },

          createdRow: function(row, rowData) {

            // evidenzia TOT massimo + CHI
            if (Number(rowData["tot"]) === maxTot) {
              var totIndex = keys.indexOf("tot");
              var chiIndex = keys.indexOf("chi");
              if (totIndex >= 0) $("td", row).eq(totIndex).addClass("max-value");
              if (chiIndex >= 0) $("td", row).eq(chiIndex).addClass("max-value");
            }

            // FORMATTZIONE INTEGRATA
            $('td', row).each(function(i) {
                const colKey = keys[i];

                // escludi tot e chi
                if (colKey !== "tot" && colKey !== "chi") {

                    $(this).css("text-align", "center");

                    const cellValue = Number(rowData[colKey]);

                    if (cellValue === 1) {
                        $(this).css("background-color", "#d9ecff");
                    } else if (cellValue === 2) {
                        $(this).css("background-color", "#a9d4ff");
                    } else {
                        $(this).css("background-color", "#f5f5dc");
                        if (cellValue === 0) {
                            $(this).css("color", "gray");
                        }
                    }
                }
            });
          },

          language: {
            search: "Cerca:",
            lengthMenu: "Mostra _MENU_ righe",
            info: "Righe _START_ - _END_ di _TOTAL_",
            paginate: { previous: "Prev", next: "Next" },
            zeroRecords: "Nessun risultato"
          }
        });

        setStatus("Tabella aggiornata: " + new Date().toLocaleString());
      },

      error: function(xhr, status, err) {
        setStatus("Errore nel caricamento: " + status + " — " + err);
      }
    });

  })();
  </script>

</body>
</html>
