<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>live dal pronosticone</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;600&display=swap" rel="stylesheet">

  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/4.3.0/css/fixedColumns.dataTables.min.css">

  <style>
    body {
      font-family: "Montserrat", sans-serif;
      margin: 12px;
      background-color: #f5f5dc !important;
    }

    /* sfondo uniforme tabella + celle + intestazioni */
    table.dataTable,
    table.dataTable tbody td,
    table.dataTable thead th {
      background-color: #f5f5dc !important;
    }

    /* sfondo anche per colonne fissate */
    .dtfc-fixed-left,
    .dtfc-fixed-left tbody tr td,
    .dtfc-fixed-left thead tr th {
      background-color: #f5f5dc !important;
    }

    /* header fisso */
    table.dataTable thead th {
      position: sticky;
      top: 0;
      z-index: 2;
    }
    
    /* righe compatte */
    table.dataTable tbody td {
      padding: 2px 6px !important;
    }
    table.dataTable thead th {
      padding: 4px 6px !important;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* evidenziazione TOT / CHI massimi */
    .max-value {
      font-weight: 700;
      color: #0066ff !important;
    }

    /* colonne 0 e 1 (prime due) sempre beige */
    td.col-0, td.col-1,
    /* anche per fixed columns clones */
    .dtfc-fixed-left td.col-0, .dtfc-fixed-left td.col-1 {
      background-color: #f5f5dc !important;
    }

    /* valori 0/1/2 */
    td.value-0 { color: #888888 !important; }               /* testo grigio per 0 */
    td.value-1 { background-color: #d9ecff !important; }    /* azzurro chiaro per 1 */
    td.value-2 { background-color: #a9d4ff !important; }    /* azzurro scuro per 2 */

    /* assicurati che testo centrato sia applicato */
    td.centered { text-align: center !important; }

  </style>
</head>

<body>
  <div class="container">
    <h2>live pronosticone</h2>
    <p id="status">Caricamento dati…</p>
    <table id="sheetTable" class="display stripe" style="width:100%">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- jQuery + DataTables + FixedColumns -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedcolumns/4.3.0/js/dataTables.fixedColumns.min.js"></script>

  <script>
  (function(){

    var API_URL = "https://script.google.com/macros/s/AKfycbzsOt3qpVNsmrgulWRMRa3eNjjVyTQ9rtJqKHcLok7DaqkqVb5zYHZqRpZ6Rdtd8TTB/exec";

    function setStatus(msg) {
      document.getElementById("status").innerText = msg;
    }

    $.ajax({
      url: API_URL + "?callback=?",
      dataType: "jsonp",
      timeout: 20000,
      success: function(data) {
        if (!data || !data.length) {
          setStatus("Nessun dato disponibile.");
          return;
        }

        setStatus("Dati caricati.");

        // recupera TUTTE le chiavi da tutte le righe (queste includono i suffissi univoci creati dallo script)
        var keys = [];
        data.forEach(row => {
          Object.keys(row).forEach(k => {
            if (!keys.includes(k)) keys.push(k);
          });
        });

        // crea una versione "pulita" delle intestazioni per la sola visualizzazione (rimuove " (2)", " (3)", ecc.)
        var displayKeys = keys.map(k => k.replace(/\s*\(\d+\)$/, ""));

        // filtra righe: esclude solo tot === "---"
        data = data.filter(row => row["tot"] !== "---");

        if (data.length === 0) {
          setStatus("Nessuna riga valida da visualizzare.");
          return;
        }

        // crea header visivo usando displayKeys (ma la DataTable continuerà a usare 'keys' come data property)
        var thead = "<tr>" + displayKeys.map(k => "<th>" + k + "</th>").join("") + "</tr>";
        $("#sheetTable thead").html(thead);

        // trova valore massimo TOT (attenzione: "tot" è uno dei key originali senza suffisso perché lo script GAS normalizza tot/chi)
        let maxTot = Math.max(...data.map(r => Number(r["tot"]) || 0));

        // DataTable: usiamo 'keys' come colonne data, ma header già impostato sopra da displayKeys
        $("#sheetTable").DataTable({
          data: data,
          columns: keys.map(k => ({
            data: function(row) {
              return row[k] !== undefined && row[k] !== "" ? row[k] : "---";
            },
            title: k
          })),

          pageLength: 25,
          lengthMenu: [10, 25, 50, 100],
          scrollX: true,
          scrollY: "70vh",
          scrollCollapse: true,
          deferRender: true,
          order: [],
          fixedColumns: { leftColumns: 2 },

          createdRow: function(row, rowData) {

            // evidenzia TOT massimo + CHI (usiamo le chiavi reali "tot" e "chi" - lo script GAS ha normalizzato i nomi base)
            // Per sicurezza cerchiamo l'indice della prima colonna il cui normalized key sia 'tot'/'chi'
            var totIndex = keys.findIndex(k => k.replace(/\s*\(\d+\)$/, "").trim().toLowerCase() === "tot");
            var chiIndex = keys.findIndex(k => k.replace(/\s*\(\d+\)$/, "").trim().toLowerCase() === "chi");

            if (totIndex >= 0 && Number(rowData[keys[totIndex]]) === maxTot) {
              $("td", row).eq(totIndex).addClass("max-value");
              if (chiIndex >= 0) $("td", row).eq(chiIndex).addClass("max-value");
            }

            // FORMATTZIONE CELLE: assegniamo classi, non inline style
            $('td', row).each(function(i) {
                const colKey = keys[i];
                const rawValue = rowData[colKey];

                // prime due colonne: assegna classe col-0/col-1 (beige)
                if (i === 0) { $(this).addClass("col-0"); return; }
                if (i === 1) { $(this).addClass("col-1"); return; }

                // testo centrato per le colonne da indice >=2
                $(this).addClass("centered");

                // proviamo a interpretare come numero il valore (se è numerico "2" o 2)
                var cellValue = (rawValue === null || rawValue === undefined) ? NaN : Number(rawValue);

                // rimuoviamo eventuali classi value-* precedenti (utile se DataTable rigenera righe)
                $(this).removeClass("value-0 value-1 value-2");

                if (!isNaN(cellValue)) {
                  if (cellValue === 0) {
                    $(this).addClass("value-0");
                  } else if (cellValue === 1) {
                    $(this).addClass("value-1");
                  } else if (cellValue === 2) {
                    $(this).addClass("value-2");
                  }
                } else {
                  // potrebbe essere una stringa tipo "1-1" (risultato) => lasciamo beige
                  // ma se il testo è '0'/'1'/'2' come stringa Number('2') è 2 e il ramo sopra lo gestisce
                }
            });
          },

          language: {
            search: "Cerca:",
            lengthMenu: "Mostra _MENU_ righe",
            info: "Righe _START_ - _END_ di _TOTAL_",
            paginate: { previous: "Prev", next: "Next" },
            zeroRecords: "Nessun risultato"
          },

          // Evitiamo che DataTables ricrei header (lo abbiamo già inserito). 
          // Alcune versioni ignorano la proprietà; se vedi header duplicati, rimuovi questa opzione.
          initComplete: function() {
            // sovrascriviamo gli header renderizzati da DataTables con quelli puliti (displayKeys)
            var ths = $("#sheetTable thead th");
            ths.each(function(idx){
              $(this).text(displayKeys[idx]);
            });
          }

        });

        setStatus("Tabella aggiornata: " + new Date().toLocaleString());
      },

      error: function(xhr, status, err) {
        setStatus("Errore nel caricamento: " + status + " — " + err);
      }
    });

  })();
  </script>

</body>
</html>
